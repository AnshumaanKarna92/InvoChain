version: '3.8'

services:
  # --- Infrastructure ---
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  zookeeper:
    image: confluentinc/cp-zookeeper:7.3.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  kafka:
    image: confluentinc/cp-kafka:7.3.0
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

  api-gateway:
    build: ./services/api-gateway
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - INVOICE_SERVICE_URL=http://invoice-service:3002
      - MERCHANT_REGISTRY_SERVICE_URL=http://merchant-registry-service:3012
      - INVENTORY_SERVICE_URL=http://inventory-service:3013
      - AUDIT_SERVICE_URL=http://audit-service:3014
      - BLOCKCHAIN_SERVICE_URL=http://blockchain-service:3003
      - NOTIFICATION_SERVICE_URL=http://notification-service:3005
      - AUTH_SERVICE_URL=http://auth-service:3011
      - PAYMENT_SERVICE_URL=http://payment-service:3010
      - BUYER_ACTION_SERVICE_URL=http://buyer-action-service:3004
      - GST_RETURN_SERVICE_URL=http://gst-return-service:3008
      - GST_ADAPTER_SERVICE_URL=http://gst-adapter-service:3009
      - RECONCILIATION_SERVICE_URL=http://reconciliation-service:3006
      - NOTE_SERVICE_URL=http://credit-debit-note-service:3007
      - REDIS_HOST=redis
    depends_on:
      - invoice-service
      - merchant-registry-service
      - inventory-service
      - audit-service
      - redis

  # --- Microservices ---
  auth-service:
    build: ./services/auth-service
    ports:
      - "3011:3011"
    environment:
      - PORT=3011
      - DATABASE_URL=postgresql://admin:password@postgres:5432/invochain
      - JWT_SECRET=dev-secret-key-change-in-prod
      - REDIS_HOST=redis
    depends_on:
      - postgres
      - redis

  invoice-service:
    build: ./services/invoice-service
    ports:
      - "3002:3002"
    environment:
      - PORT=3002
      - DATABASE_URL=postgresql://admin:password@postgres:5432/invochain
      - INVENTORY_SERVICE_URL=http://inventory-service:3013
      - REDIS_HOST=redis
      - KAFKA_BROKERS=kafka:29092
    volumes:
      - ./services/storage:/app/storage
    depends_on:
      - postgres
      - inventory-service
      - redis
      - kafka

  merchant-registry-service:
    build: ./services/merchant-registry-service
    ports:
      - "3012:3012"
    environment:
      - PORT=3012
      - DATABASE_URL=postgresql://admin:password@postgres:5432/invochain
    depends_on:
      - postgres

  inventory-service:
    build: ./services/inventory-service
    ports:
      - "3013:3013"
    environment:
      - PORT=3013
      - DATABASE_URL=postgresql://admin:password@postgres:5432/invochain
      - REDIS_HOST=redis
    depends_on:
      - postgres
      - redis

  audit-service:
    build: ./services/audit-service
    ports:
      - "3014:3014"
    environment:
      - PORT=3014
      - DATABASE_URL=postgresql://admin:password@postgres:5432/invochain
    depends_on:
      - postgres

  blockchain-service:
    build: ./services/blockchain-service
    ports:
      - "3003:3003"
    environment:
      - PORT=3003

  notification-service:
    build: ./services/notification-service
    ports:
      - "3005:3005"
    environment:
      - PORT=3005

  payment-service:
    build: ./services/payment-service
    ports:
      - "3010:3010"
    environment:
      - PORT=3010
      - DATABASE_URL=postgresql://admin:password@postgres:5432/invochain
      - INVOICE_SERVICE_URL=http://invoice-service:3002
    depends_on:
      - postgres

  buyer-action-service:
    build: ./services/buyer-action-service
    ports:
      - "3004:3004"
    environment:
      - PORT=3004

  gst-return-service:
    build: ./services/gst-return-service
    ports:
      - "3008:3008"
    environment:
      - PORT=3008
      - DATABASE_URL=postgresql://admin:password@postgres:5432/invochain
    depends_on:
      - postgres

  gst-adapter-service:
    build: ./services/gst-adapter-service
    ports:
      - "3009:3009"
    environment:
      - PORT=3009

  reconciliation-service:
    build: ./services/reconciliation-service
    ports:
      - "3006:3006"
    environment:
      - PORT=3006
      - DATABASE_URL=postgresql://admin:password@postgres:5432/invochain
    depends_on:
      - postgres

  credit-debit-note-service:
    build: ./services/credit-debit-note-service
    ports:
      - "3007:3007"
    environment:
      - PORT=3007

  # --- Frontend ---
  web:
    build: ./apps/web
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:3000/api
    depends_on:
      - api-gateway
    volumes:
      - ./apps/web:/app
      - /app/node_modules

  # --- Database ---
  postgres:
    image: postgres:15
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=invochain
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
  redis_data:
